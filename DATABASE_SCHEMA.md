# Supabase Database Schema & Setup

## Notes Table Structure

This is the primary table used by both Problems and Stores features.

### SQL Definition

```sql
CREATE TABLE notes (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  location TEXT,
  price NUMERIC,
  category TEXT,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
);

-- Create index for faster queries by user
CREATE INDEX idx_notes_user_id ON notes(user_id);

-- Create index for sorting by creation date
CREATE INDEX idx_notes_created_at ON notes(created_at DESC);
```

---

## Column Definitions

| Column | Type | Required | Description | Used By |
|--------|------|----------|-------------|---------|
| `id` | BIGINT | Yes | Auto-incrementing primary key | System |
| `created_at` | TIMESTAMP | Yes (auto) | Creation timestamp | System |
| `title` | TEXT | Yes | Problem/Store name | Both |
| `description` | TEXT | Yes | Full description | Both |
| `location` | TEXT | No | Geographic location | Both |
| `price` | NUMERIC | No | Price/cost | Stores only |
| `category` | TEXT | No | Category type | Stores only |
| `user_id` | UUID | Yes | Owner's user ID | System |

---

## Data Type Reference

### TEXT
- Used for: title, description, location, category
- Max length: 1 GB (but practically unlimited for our use)
- Supports UTF-8 characters

### NUMERIC
- Used for: price
- Precision: Up to 131,072 digits before decimal, 16,383 after
- Good for: Money values

### BIGINT
- Used for: id
- Range: -2^63 to 2^63-1
- Auto-incrementing via GENERATED BY DEFAULT AS IDENTITY

### UUID
- Used for: user_id (references auth.users)
- Format: 32 hexadecimal characters with hyphens
- Example: `550e8400-e29b-41d4-a716-446655440000`

### TIMESTAMP WITH TIME ZONE
- Used for: created_at
- Format: ISO 8601
- Example: `2024-02-04T15:30:00+00:00`
- Auto-sets to current time on creation

---

## Sample Data

### Problem Entry
```json
{
  "id": 1,
  "created_at": "2024-02-04T10:00:00+00:00",
  "title": "Transport",
  "description": "There isn't any reliable public transport to travel on a daily basis...",
  "location": "Midrand",
  "price": null,
  "category": null,
  "user_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Store Entry
```json
{
  "id": 2,
  "created_at": "2024-02-04T11:30:00+00:00",
  "title": "Fresh Vegetables",
  "description": "Local farm-fresh vegetables delivered daily...",
  "location": "Soweto",
  "price": 50.99,
  "category": "Delivery",
  "user_id": "660f8500-e39b-41d4-a716-446655441111"
}
```

---

## Foreign Key Relationship

```
auth.users (Supabase built-in)
    ↓ (references)
    ↓ id → user_id
notes (our table)
```

This ensures:
- Each note belongs to exactly one user
- When a user is deleted, their notes are automatically deleted (CASCADE)
- Invalid user_ids are rejected at the database level

---

## Indexes for Performance

### Index 1: `idx_notes_user_id`
```sql
CREATE INDEX idx_notes_user_id ON notes(user_id);
```
**Purpose**: Fast lookup of all notes by a specific user  
**Query**: `SELECT * FROM notes WHERE user_id = 'xxx'`  
**Speed**: O(log n) instead of O(n)

### Index 2: `idx_notes_created_at`
```sql
CREATE INDEX idx_notes_created_at ON notes(created_at DESC);
```
**Purpose**: Fast reverse chronological ordering  
**Query**: `SELECT * FROM notes ORDER BY created_at DESC`  
**Speed**: O(log n) instead of O(n)

---

## How to Create the Table in Supabase

### Method 1: Using Supabase Dashboard

1. Open your Supabase project
2. Go to "SQL Editor"
3. Click "New Query"
4. Copy and paste the SQL definition above
5. Click "Run"

### Method 2: Using PostgreSQL CLI

```bash
# Connect to your Supabase database
psql -h db.xxx.supabase.co -U postgres -d postgres

# Paste the SQL definition and run
```

### Method 3: Using Supabase API

Create via the Supabase management API (advanced).

---

## Row-Level Security (RLS)

### Recommended RLS Policies

```sql
-- Policy: Users can only read their own notes
CREATE POLICY "Users can read own notes"
ON notes
FOR SELECT
USING (auth.uid() = user_id);

-- Policy: Users can only insert their own notes
CREATE POLICY "Users can insert own notes"
ON notes
FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Policy: Users can only update their own notes
CREATE POLICY "Users can update own notes"
ON notes
FOR UPDATE
USING (auth.uid() = user_id);

-- Policy: Users can only delete their own notes
CREATE POLICY "Users can delete own notes"
ON notes
FOR DELETE
USING (auth.uid() = user_id);

-- Enable RLS
ALTER TABLE notes ENABLE ROW LEVEL SECURITY;
```

**Note**: Our backend implements this check manually via:
```javascript
.eq("user_id", userId)  // In Supabase queries
```

---

## Data Validation Rules

### Client-Side (Frontend)
- Title: Required, non-empty
- Description: Required, non-empty
- Location: Required for display, non-empty
- Price: Optional, numeric, >= 0
- Category: Optional, should match predefined list

### Server-Side (Backend)
```javascript
if (!title || !description || !location) {
  return 400; // Bad Request
}
```

### Database-Level
- `title TEXT NOT NULL` → Cannot be null/empty
- `description TEXT NOT NULL` → Cannot be null/empty
- `user_id UUID NOT NULL` → Must be valid user
- `price NUMERIC` → Must be valid number if provided

---

## Querying Examples

### Get all notes for a user
```javascript
const { data } = await supabase
  .from('notes')
  .select('*')
  .eq('user_id', userId)
  .order('created_at', { ascending: false });
```

### Get single note
```javascript
const { data } = await supabase
  .from('notes')
  .select('*')
  .eq('id', noteId)
  .eq('user_id', userId)
  .single();
```

### Search notes
```javascript
const { data } = await supabase
  .from('notes')
  .select('*')
  .eq('user_id', userId)
  .or(`title.ilike.%${query}%,description.ilike.%${query}%`)
  .order('created_at', { ascending: false });
```

### Filter by category (Stores)
```javascript
const { data } = await supabase
  .from('notes')
  .select('*')
  .eq('user_id', userId)
  .eq('category', 'Delivery')
  .order('created_at', { ascending: false });
```

---

## Backups & Disaster Recovery

### Automatic Backups
Supabase automatically backs up your database:
- Daily backups kept for 7 days
- Weekly backups kept for 4 weeks
- Monthly backups kept for 1 year

### Manual Export
```sql
-- Export to CSV
\copy (SELECT * FROM notes) TO 'notes_backup.csv' WITH CSV HEADER;

-- Or use Supabase Dashboard → Database → Backups
```

### Restore from Backup
1. Go to Supabase Dashboard
2. Select your project
3. Go to Settings → Backups
4. Choose backup date
5. Click "Restore"

---

## Monitoring & Maintenance

### Check Table Size
```sql
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename = 'notes';
```

### Check Row Count
```sql
SELECT COUNT(*) FROM notes;
```

### Check Index Usage
```sql
SELECT * FROM pg_stat_user_indexes WHERE relname = 'notes';
```

### Analyze Query Performance
```sql
EXPLAIN ANALYZE SELECT * FROM notes WHERE user_id = 'xxx';
```

---

## Optimization Tips

### Query Performance
- Always filter by `user_id` first (indexed)
- Use indexes for frequent WHERE clauses
- Avoid SELECT * if you only need specific columns
- Use LIMIT for pagination

### Storage Performance
- Archive old notes if table gets large (>1M rows)
- Compress text fields if they contain large content
- Consider partitioning by user_id for massive datasets

### Scalability Plan
- **< 100K rows**: Current setup is fine
- **100K-1M rows**: Add more indexes, implement pagination
- **> 1M rows**: Consider table partitioning or archiving

---

## Disaster Recovery Plan

### In Case of Data Loss

1. **Immediate**: Stop all API calls
2. **Restore**: Go to Supabase Backups, restore latest
3. **Verify**: Check data is restored correctly
4. **Communicate**: Notify users of incident

### In Case of Security Breach

1. **Immediate**: Disable all sessions
2. **Force**: Require all users to reset passwords
3. **Audit**: Check Supabase logs for unauthorized access
4. **Update**: Change Supabase keys if compromised

### In Case of Corruption

1. **Backup**: Restore from clean backup
2. **Verify**: Check data integrity
3. **Investigate**: Find root cause
4. **Prevent**: Implement additional validation

---

## Compliance & Data Protection

### GDPR Compliance
- Users own their data
- Users can request data export: provide their notes
- Users can request deletion: cascade deletes from DB
- Store consent for data processing

### Data Privacy
- Notes are private by default (not publicly accessible)
- Only authenticated users can access their notes
- Backend validates ownership on every request
- Consider encryption for sensitive data

---

## Cost Implications

### Supabase Pricing (as of 2024)
- **Free Tier**: Up to 500MB storage
- **Pro**: $25/month + overages
- **Storage**: $0.25 per GB over limit

### Optimization for Cost
- Delete old notes regularly
- Archive instead of storing indefinitely
- Use compression for large fields
- Monitor storage usage monthly

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2024-02-04 | Initial schema created |
| | | 8 columns, 2 indexes |
| | | Foreign key to auth.users |

---

## References

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Data Types](https://www.postgresql.org/docs/current/datatype.html)
- [SQL Indexes](https://www.postgresql.org/docs/current/sql-createindex.html)
- [Foreign Keys](https://www.postgresql.org/docs/current/ddl-constraints.html#ddl-constraints-fk)

---

## Support

For database issues:
1. Check Supabase Logs (Dashboard → Logs)
2. Review SQL error messages
3. Test queries in SQL Editor
4. Check Row-Level Security policies
5. Verify user authentication
