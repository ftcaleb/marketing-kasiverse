# Quick Reference - CRUD Operations

## API Functions (from `src/lib/api.js`)

### Get All Notes
```javascript
import { getNotes } from '../lib/api';

const notes = await getNotes();
// Returns: Array of all user's notes
```

### Create Note
```javascript
import { createNote } from '../lib/api';

const newNote = await createNote({
  title: "Problem Title",
  description: "Full description",
  location: "City name",
  price: 100,      // optional
  category: "Type" // optional
});
// Returns: { id, title, description, location, price, category, user_id, created_at }
```

### Update Note
```javascript
import { updateNote } from '../lib/api';

const updated = await updateNote(noteId, {
  title: "New Title",
  description: "Updated desc",
  location: "New City"
});
// Returns: Updated note object
```

### Delete Note
```javascript
import { deleteNote } from '../lib/api';

await deleteNote(noteId);
// Returns: { message: "Note deleted successfully" }
```

### Check Authentication
```javascript
import { isAuthenticated } from '../lib/api';

if (isAuthenticated()) {
  // User has valid token
}
```

---

## Component Patterns

### Using API in a Page Component
```javascript
import { useEffect, useState } from 'react';
import { getNotes, isAuthenticated } from '../lib/api';

function MyPage() {
  const [notes, setNotes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    // Check auth
    if (!isAuthenticated()) {
      navigate('/login');
      return;
    }

    // Fetch data
    const fetchData = async () => {
      try {
        setLoading(true);
        const data = await getNotes();
        setNotes(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // JSX...
}
```

### Handling Create in Modal
```javascript
async function handleSubmit(e) {
  e.preventDefault();
  setLoading(true);
  setError('');

  try {
    const newNote = await createNote({
      title,
      description,
      location
    });
    
    // Add to state
    setNotes([newNote, ...notes]);
    
    // Close modal
    closeModal();
  } catch (err) {
    setError(err.message);
  } finally {
    setLoading(false);
  }
}
```

### Handling Edit on Card
```javascript
async function handleSave() {
  try {
    setLoading(true);
    const updated = await updateNote(noteId, editData);
    
    // Update in state
    setNotes(notes.map(n => n.id === noteId ? updated : n));
    
    // Exit edit mode
    setIsEditing(false);
  } catch (err) {
    setError(err.message);
  } finally {
    setLoading(false);
  }
}
```

### Handling Delete
```javascript
async function handleDelete() {
  if (!confirm('Are you sure?')) return;

  try {
    setLoading(true);
    await deleteNote(noteId);
    
    // Remove from state
    setNotes(notes.filter(n => n.id !== noteId));
  } catch (err) {
    setError(err.message);
    setLoading(false);
  }
}
```

---

## Common Patterns

### Loading State
```javascript
{isLoading ? (
  <p>Loading...</p>
) : filteredNotes.length > 0 ? (
  // Render items
) : (
  <p>No items found</p>
)}
```

### Error Display
```javascript
{error && (
  <div className="error-box">
    {error}
    <button onClick={retry}>Retry</button>
  </div>
)}
```

### Optimistic Update
```javascript
// 1. Update UI immediately
setNotes([newNote, ...notes]);

// 2. Send to server
try {
  await createNote(newNote);
} catch (err) {
  // Rollback on error
  setNotes(notes.filter(n => n.id !== newNote.id));
}
```

---

## Error Codes & Handling

| Status | Meaning | Action |
|--------|---------|--------|
| 401 | Unauthorized | Token expired, redirect to login |
| 404 | Not Found | Note doesn't exist, remove from state |
| 400 | Bad Request | Show error message to user |
| 500 | Server Error | Show generic error, allow retry |

---

## Supabase Table Schema

```sql
CREATE TABLE notes (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  created_at TIMESTAMP DEFAULT NOW(),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  location TEXT,
  price NUMERIC,
  category TEXT,
  user_id UUID REFERENCES auth.users(id)
);

-- Create index for faster queries
CREATE INDEX idx_notes_user_id ON notes(user_id);
```

---

## Environment Setup

### Backend (.env)
```
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_anon_key
PORT=3001
```

### Frontend (.env or .env.local)
```
VITE_BACKEND_URL=http://localhost:3001
```

---

## Debugging

### Check Token
```javascript
console.log(localStorage.getItem('token'));
```

### Test API Directly
```javascript
const token = localStorage.getItem('token');
fetch('http://localhost:3001/notes', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
})
.then(r => r.json())
.then(console.log)
.catch(console.error);
```

### Check Supabase Logs
1. Go to Supabase Dashboard
2. Select your project
3. Check "Logs" section for errors

---

## Key Points

✅ Always import from `../lib/api`  
✅ Always wrap API calls in try/catch  
✅ Always show loading states  
✅ Always handle errors gracefully  
✅ Always check auth before protected pages  
✅ Always validate form inputs  
✅ Always confirm before delete  

---

## Common Mistakes to Avoid

❌ Forgetting `await` on async functions  
❌ Not checking `isAuthenticated()` on protected pages  
❌ Not handling errors from API calls  
❌ Modifying state before API confirms  
❌ Forgetting to import API functions  
❌ Not providing user feedback during operations  
❌ Making API calls in render (not in useEffect)  

---

## Performance Tips

- Use `useEffect` dependencies properly
- Avoid unnecessary re-renders with proper state structure
- Implement pagination for large datasets
- Cache notes in state (don't refetch unnecessarily)
- Use loading state to prevent duplicate submissions
